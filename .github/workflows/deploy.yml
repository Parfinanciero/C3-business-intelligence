name: Deploy to VPS

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Java
              uses: actions/setup-java@v3
              with:
                  java-version: '21'
                  distribution: 'temurin'

            - name: Build JAR file with Maven
              run: |
                  mvn clean package
                  ls -l target/*.jar
        
            - name: Deploy to Server
              uses: appleboy/ssh-action@v1.2.0
              with:
                    host: ${{ secrets.SERVER_HOST }}
                    username: ${{ secrets.SERVER_USERNAME }}
                    key: ${{ secrets.SERVER_KEY }}
                    port: ${{ secrets.SERVER_PORT }}
                    script: |
                        DEPLOY_DIR="/home/admin_jb_3"
                        LOGS_DIR="$DEPLOY_DIR/logs"
                        APP_JAR="Bussiness-0.0.1-SNAPSHOT.jar"

                        sudo pkill -f $APP_JAR || true

                        scp target/*.jar $DEPLOY_DIR/

                        nohup java -jar $DEPLOY_DIR/$APP_JAR > $LOGS_DIR/output.log 2>&1 &

                        echo "Deploy completed"
